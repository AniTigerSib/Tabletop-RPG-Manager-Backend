services:
  app:
    build: .
    container_name: trpg_prod_app
    environment:
      SPRING_PROFILES_ACTIVE: prod
      PGHOST: trpg_prod_db
      PGPORT: 5432
      PGDATABASE: trpg_db
      PGUSER: trpg_user
      PGPASSWORD: ${PGPASSWORD}
      REDIS_HOST: trpg_prod_redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_BUCKET: ${S3_BUCKET}
      S3_PUBLIC_BASE_URL: ${S3_PUBLIC_BASE_URL}
      S3_REGION: ${S3_REGION}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_PUBLIC_READ: ${S3_PUBLIC_READ}
      LOG_PATH: /app/logs
    ports:
      - "9010:9010"
      - "127.0.0.1:9011:9011"
    volumes:
      - prod_app_logs:/app/logs
    depends_on:
      trpg_prod_db:
        condition: service_healthy
      trpg_prod_redis:
        condition: service_healthy

  trpg_prod_db:
    image: postgres:15-alpine
    container_name: trpg_prod_db
    environment:
      POSTGRES_DB: trpg_db
      POSTGRES_USER: trpg_user
      POSTGRES_PASSWORD: ${PGPASSWORD}
    volumes:
      - prod_postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trpg_user -d trpg_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  trpg_prod_redis:
    image: redis:7-alpine
    container_name: trpg_prod_redis
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - prod_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  prod_postgres_data:
  prod_redis_data:
  prod_app_logs:
